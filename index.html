<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="YMUdLLxf9PLltIdUJL9HtO48mq3qCTfEvmLzgltebJk" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense - AI Plant Diagnosis</title>
    <!-- Load Tailwind CSS for Splendid Aesthetics -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for aesthetic results box */
        #results-container {
            max-height: 65vh;
            overflow-y: auto;
        }
        #results-container::-webkit-scrollbar {
            width: 8px;
        }
        #results-container::-webkit-scrollbar-thumb {
            background-color: #A7F3D0; /* Light green-200 */
            border-radius: 4px;
        }
        #results-container::-webkit-scrollbar-track {
            background-color: #F0FDF4; /* Very light green-50 */
        }
        .prose h3 {
            margin-top: 1.5em !important;
            margin-bottom: 0.5em !important;
            padding-bottom: 0.25em !important;
            border-bottom: 2px solid #10B981; /* agri-green */
            font-weight: 700 !important;
            color: #064E3B; /* agri-dark */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'agri-green': '#10B981', // Emerald 500
                        'agri-light-green': '#ECFDF5', // Green 50
                        'agri-yellow': '#FBBF24', // Amber 500 (Gold accent)
                        'agri-dark': '#064E3B', // Emerald 900
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-agri-light-green text-agri-dark min-h-screen flex items-center justify-center p-4 sm:p-8">

    <div class="w-full max-w-4xl bg-white p-6 sm:p-10 rounded-3xl shadow-[0_20px_50px_rgba(16,185,129,0.3)] transition-all duration-500">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-agri-green drop-shadow-lg leading-tight">
                <span class="inline-block transform -translate-y-1">â˜˜</span> PlantIQ
            </h1>
            <p class="mt-2 text-agri-dark/80 text-xl font-medium">Identify, Diagnose, & Prevent Plant Illnesses</p>
        </header>

        <!-- Input & Capture Section -->
        <section class="mb-8 p-6 border-2 border-agri-green/40 rounded-2xl bg-agri-green/5">
            <h2 class="text-2xl font-bold mb-4 text-agri-dark">1. Capture or Upload Image</h2>
            
            <div class="flex flex-col lg:flex-row gap-6">
                
                <!-- Upload & Drop Area -->
                <div id="dropZone" class="lg:w-1/2 p-6 border-4 border-dashed border-agri-green/70 rounded-xl bg-white/70 hover:bg-white transition-colors cursor-pointer text-center">
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <p class="text-xl font-semibold text-agri-dark/80 mb-2">Drag & Drop Image Here</p>
                    <p class="text-agri-dark/60 text-sm">or <span class="text-agri-green font-bold underline">click to browse</span></p>
                </div>

                <!-- Camera Button & Controls -->
                <div class="lg:w-1/2 flex flex-col items-center space-y-4">
                    <button id="cameraBtn" 
                        class="w-full py-3 px-6 text-lg font-bold rounded-xl text-agri-dark bg-agri-yellow shadow-md transition-all duration-300 transform hover:scale-[1.01] active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-agri-yellow/50">
                        ðŸ“· Activate Camera
                    </button>
                    <button id="captureBtn" style="display:none;" 
                        class="w-full py-3 px-6 text-lg font-bold rounded-xl text-white bg-agri-green shadow-md transition-all duration-300 hover:bg-agri-dark focus:outline-none focus:ring-4 focus:ring-agri-green/50">
                        ðŸ“¸ Take Photo
                    </button>
                </div>
            </div>

            <!-- Video/Preview Area -->
            <div class="mt-6 relative w-full h-auto min-h-[200px] bg-gray-100 rounded-xl overflow-hidden shadow-xl flex items-center justify-center border border-agri-dark/20">
                <video id="video" autoplay playsinline class="w-full h-full object-cover hidden rounded-xl"></video>
                <img id="preview" src="" alt="Image Preview" class="h-full w-full object-contain hidden rounded-xl">
                <canvas id="canvas" style="display:none;"></canvas>
                <span id="previewPlaceholder" class="text-gray-400 text-center p-6 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                    Upload an image or activate your camera.
                </span>
            </div>
        </section>

        <!-- Diagnosis Button & Loading -->
        <section class="mb-8">
            <button id="diagnoseButton" onclick="processImage()" disabled
                class="w-full py-4 px-6 text-xl font-extrabold rounded-2xl text-agri-dark bg-agri-yellow shadow-[0_10px_20px_rgba(251,191,36,0.4)] transition-all duration-300 transform hover:scale-[1.01] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none focus:outline-none focus:ring-4 focus:ring-agri-yellow/50"
                title="Upload or capture an image to enable diagnosis"
            >
                2. Diagnose Plant ðŸŒ¿
            </button>
            <div id="loadingIndicator" class="mt-4 hidden text-center text-agri-green font-semibold">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-agri-green border-agri-green/20 rounded-full"></div>
                <p class="mt-2 text-lg">Analyzing plant structure and symptoms with AI...</p>
            </div>
        </section>

        <!-- Results Section -->
        <section class="mt-8">
            <h2 class="text-2xl font-bold mb-4 text-agri-dark">3. AI Diagnosis & Treatment Plan</h2>
            <div id="results-container" class="min-h-[250px] w-full bg-agri-light-green p-6 rounded-2xl shadow-inner border border-agri-green/50 text-agri-dark/90 prose prose-lg max-w-none">
                <p id="initialMessage" class="text-center text-gray-500 italic pt-12">
                    Your detailed plant diagnosis and personalized treatment plan will be displayed here after analysis.
                </p>
                <div id="diagnosisOutput" class="hidden"></div>
            </div>
        </section>
        
        <!-- Error/Status Message Box -->
        <div id="statusMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert"></div>

    </div>

    <!-- Firebase and AI Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-agrisense-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // API key will be automatically provided by the Canvas environment if left empty
        const apiKey = "AIzaSyB6oX8SPPd-13jtrWHE43_oy6MH4vkUtus"; 

        let auth, userId;
        let videoStream = null;

        // Get DOM Elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const cameraBtn = document.getElementById('cameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('previewPlaceholder');
        const diagnoseButton = document.getElementById('diagnoseButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const diagnosisOutput = document.getElementById('diagnosisOutput');
        const initialMessage = document.getElementById('initialMessage');
        const statusEl = document.getElementById('statusMessage');


        // --- Firebase Initialization (Mandatory for environment) ---
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);

            window.addEventListener('load', async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase Auth Initialized. User ID:", userId);
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                }
            });
        }

        // --- Utility Functions ---

        /** Converts a File object to a Base64 string. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return reject("No file provided.");
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Simple Markdown to HTML converter (for safety and presentation) */
        function markdownToHtml(markdown) {
            // Convert headings (##)
            markdown = markdown.replace(/^##\s*(.*)$/gm, '<h3>$1</h3>');
            // Convert list items
            markdown = markdown.replace(/^\*\s*(.*)$/gm, '<li>$1</li>');
            // Convert ordered list items (1.)
            markdown = markdown.replace(/^[0-9]+\.\s*(.*)$/gm, '<li>$1</li>');
            // Wrap lists in ul/ol if necessary (simple heuristic)
            if (markdown.includes('<li>')) {
                // Heuristic for list wrapping
                const listPattern = /(^<li>.*<\/li>\s*)+/gms;
                markdown = markdown.replace(listPattern, '<ul>$&</ul>');
            }
            // Bold text
            markdown = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Ensure paragraphs are handled nicely (using <br> for simple line breaks if no list/heading follows)
            markdown = markdown.replace(/(^.+$)\n(?!<h3|<ul>|<ol|<li>)/gm, '$1<br>');
            return markdown;
        }

        /** Handles displaying error/status messages. */
        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = `mt-4 p-3 border rounded-lg ${
                isError ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700'
            }`;
            statusEl.classList.remove('hidden');
        }

        function enableDiagnosis(isReady) {
            diagnoseButton.disabled = !isReady;
            diagnoseButton.title = isReady ? 'Click to start the AI analysis' : 'Upload or capture an image to enable diagnosis';
        }
        
        function resetUI() {
            diagnosisOutput.innerHTML = '';
            diagnosisOutput.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            statusEl.classList.add('hidden');
            enableDiagnosis(false);
        }
        
        function stopVideoStream() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                video.classList.add('hidden');
                captureBtn.style.display = 'none';
                cameraBtn.textContent = 'ðŸ“· Activate Camera';
            }
        }

        // --- Image Capture/Upload Handlers ---

        function displayImage(dataUrl) {
            resetUI();
            stopVideoStream();
            preview.src = dataUrl;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            enableDiagnosis(true);
        }

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showStatus("Please upload a valid image file.", true);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => displayImage(e.target.result);
            reader.readAsDataURL(file);
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // Drag & Drop Handlers
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-agri-yellow', 'bg-agri-yellow/20');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-agri-yellow', 'bg-agri-yellow/20');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-agri-yellow', 'bg-agri-yellow/20');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        // Camera Activation
        cameraBtn.addEventListener('click', async () => {
            if (videoStream) {
                stopVideoStream();
                preview.classList.remove('hidden'); // Show last captured image or hide if no capture
                placeholder.classList.remove('hidden');
                enableDiagnosis(false);
                resetUI();
                return;
            }

            try {
                resetUI();
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = videoStream;
                video.classList.remove('hidden');
                preview.classList.add('hidden');
                placeholder.classList.add('hidden');
                captureBtn.style.display = 'block';
                cameraBtn.textContent = 'ðŸ›‘ Stop Camera';
                enableDiagnosis(false); // Enable only after capture
            } catch (err) {
                console.error("Camera access denied or failed: ", err);
                showStatus("Error: Could not access the camera. Check permissions.", true);
            }
        });

        // Photo Capture
        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video stream's actual size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the current frame
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data URL
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            
            // Display the captured image in the preview element
            displayImage(dataUrl);

            // Stop the video stream after capture
            stopVideoStream();
            showStatus("Photo captured successfully. Ready for diagnosis.", false);
        });

        // --- Core AI Diagnosis Function ---

        window.processImage = async function() {
            const dataUrl = preview.src;

            if (!dataUrl) {
                showStatus("Please capture or select an image file first.", true);
                return;
            }

            if (!apiKey) {
                showStatus("Error: API Key is missing. Cannot perform diagnosis.", true);
                return;
            }
            
            // Prepare image data for API
            const [mimeTypePart, base64Data] = dataUrl.split(',');
            const mimeType = mimeTypePart.match(/:(.*?);/)[1];
            
            // Clear previous results and hide status
            diagnosisOutput.innerHTML = '';
            diagnosisOutput.classList.add('hidden');
            initialMessage.classList.add('hidden');
            statusEl.classList.add('hidden');

            // Set Loading State
            enableDiagnosis(false);
            diagnoseButton.textContent = 'Analyzing...';
            loadingIndicator.classList.remove('hidden');

            try {
                // 1. Define the prompt for the AI
                const prompt = `Act as an expert agronomist and plant pathologist. Analyze the provided image of the plant/leaf. Identify the plant and assess its health. Provide the output in this structured format EXACTLY, using only Markdown headings (##) for structure.
                
                ## Plant Identified
                [Name of the plant (e.g., Tomato, Rose, Fern) and a brief sentence describing its typical appearance or type.]

                ## Diagnosis & Status
                [Detailed health status. If the plant appears healthy, state: 'The plant appears healthy and robust, showing no immediate signs of disease or stress.' If it is sick, clearly state the specific disease, pest, or deficiency (e.g., 'Early Blight (Fungal Disease)', 'Aphid Infestation', 'Nitrogen Deficiency') and explain the visual evidence seen in the image.]

                ## Treatment & Prevention
                [Provide specific, actionable steps for treatment. If the plant is healthy, provide 3-4 general best practices for maintenance (e.g., watering tips, sunlight exposure, soil needs) to prevent future issues.]`;
                
                // 2. Construct the API payload
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                let response;
                let lastDelay = 1000;
                const maxRetries = 3;

                // Implement exponential backoff for API call
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status !== 429) { 
                            break; 
                        }

                        console.warn(`Rate limit hit (429). Retrying in ${lastDelay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, lastDelay));
                        lastDelay *= 2; 
                    } catch (fetchError) {
                        if (i === maxRetries - 1) throw fetchError;
                        console.error("Fetch attempt failed:", fetchError);
                        await new Promise(resolve => setTimeout(resolve, lastDelay));
                        lastDelay *= 2;
                    }
                }

                if (!response || !response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Request failed with status ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiText) {
                    // 3. Render the AI response
                    const htmlContent = markdownToHtml(aiText);
                    diagnosisOutput.innerHTML = htmlContent;
                    diagnosisOutput.classList.remove('hidden');
                    showStatus("Diagnosis Complete! Review the splendid results below.", false);
                } else {
                    showStatus("AI did not return a valid response. Please try a different image.", true);
                    console.error("AI Response structure error:", result);
                }

            } catch (error) {
                console.error("Diagnosis Error:", error);
                showStatus("An error occurred during diagnosis. Check the console for details.", true);
            } finally {
                // Reset Loading State
                enableDiagnosis(true);
                diagnoseButton.textContent = '2. Diagnose Plant ðŸŒ¿';
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>

</html>

